"use client";

import { useState, useEffect } from "react";
import { useAuth } from "@/context/AuthContext";
import { db } from "@/lib/firebase";
import { collection, query, where, getDocs, doc, updateDoc, getDoc, Timestamp } from "firebase/firestore";
import { X, User, Calendar, CreditCard, ChevronRight, Trash2, UserCheck, UserX, Clock, AlertCircle, Search } from "lucide-react";

interface Member {
    id: string;
    name: string;
    email: string;
    status: string;
    phoneNumber?: string;
    gymId: string;
    plan?: {
        id: string;
        name: string;
        expiry: any;
    }
}

interface Plan {
    id: string;
    name: string;
    durationMonths: number;
    price: number;
}

export default function MembersPage() {
    const { user } = useAuth();
    const [members, setMembers] = useState<Member[]>([]);
    const [plans, setPlans] = useState<Plan[]>([]);
    const [loading, setLoading] = useState(true);
    const [activeTab, setActiveTab] = useState<'pending' | 'active' | 'expiring_soon' | 'expired' | 'rejected'>('active');
    const [selectedMember, setSelectedMember] = useState<Member | null>(null);
    const [selectedPlanId, setSelectedPlanId] = useState<string>("");
    const [searchQuery, setSearchQuery] = useState("");

    useEffect(() => {
        fetchData();
    }, [user]);

    const fetchData = async () => {
        if (!user) return;

        try {
            const userDoc = await getDoc(doc(db, \"users\", user.uid));
            const gymId = userDoc.data()?.gymId;
            if (!gymId) return;

            // Fetch members
            const membersQuery = query(collection(db, \"users\"), where(\"gymId\", \"==\", gymId), where(\"role\", \"==\", \"USER\"));
            const membersSnap = await getDocs(membersQuery);
            const membersData = membersSnap.docs.map(d => ({ id: d.id, ...d.data() } as Member));
            setMembers(membersData);

            // Fetch plans
            const plansQuery = query(collection(db, \"plans\"), where(\"gymId\", \"==\", gymId));
            const plansSnap = await getDocs(plansQuery);
            const plansData = plansSnap.docs.map(d => ({ id: d.id, ...d.data() } as Plan));
            setPlans(plansData);

        } catch (error) {
            console.error(\"Error fetching data:\", error);
        } finally {
            setLoading(false);
        }
    };

    const handleApprove = async (memberId: string) => {
        try {
            await updateDoc(doc(db, \"users\", memberId), { status: \"ACTIVE\" });
            fetchData();
        } catch (error) {
            console.error(\"Error approving member:\", error);
        }
    };

    const handleReject = async (memberId: string) => {
        try {
            await updateDoc(doc(db, \"users\", memberId), { status: \"REJECTED\" });
            fetchData();
        } catch (error) {
            console.error(\"Error rejecting member:\", error);
        }
    };

    const handlePlanChange = (planId: string) => {
        setSelectedPlanId(planId);
    };

    const handleAssignPlan = async () => {
        if (!selectedMember || !selectedPlanId) return;

        try {
            const selectedPlan = plans.find(p => p.id === selectedPlanId);
            if (!selectedPlan) return;

            const expiryDate = new Date();
            expiryDate.setMonth(expiryDate.getMonth() + selectedPlan.durationMonths);

            await updateDoc(doc(db, \"users\", selectedMember.id), {
                plan: {
                id: selectedPlan.id,
                name: selectedPlan.name,
                price: selectedPlan.price,
                expiry: Timestamp.fromDate(expiryDate)
            },
                status: \"ACTIVE\"
            });

        setSelectedMember(null);
        setSelectedPlanId(\"\");
            fetchData();
    } catch (error) {
        console.error(\"Error assigning plan:\", error);
        }
};

const handleRemoveMember = async (memberId: string, memberName: string) => {
    if (!confirm(`Remove ${memberName} from the gym? This action cannot be undone.`)) return;

    try {
        await updateDoc(doc(db, \"users\", memberId), {
                status: \"REMOVED\",
                gymId: \"\"
            });
    fetchData();
} catch (error) {
    console.error(\"Error removing member:\", error);
        }
    };

const getComputedStatus = (member: Member): string => {
    if (member.status === 'PENDING') return 'PENDING';
    if (member.status === 'REJECTED') return 'REJECTED';

    if (!member.plan?.expiry) return 'ACTIVE';

    const now = new Date();
    const expiry = new Date(member.plan.expiry.seconds * 1000);
    const sevenDaysFromNow = new Date();
    sevenDaysFromNow.setDate(now.getDate() + 7);

    if (expiry < now) return 'EXPIRED';
    if (expiry <= sevenDaysFromNow) return 'EXPIRING_SOON';

    return 'ACTIVE';
};

const filteredMembers = members.filter((m) => {
    const status = getComputedStatus(m);
    const matchesTab = status === activeTab.toUpperCase();
    const matchesSearch = m.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
        m.email.toLowerCase().includes(searchQuery.toLowerCase());
    return matchesTab && matchesSearch;
});

const tabConfig = [
    { key: 'pending', label: 'Pending', icon: Clock, color: 'amber' },
    { key: 'active', label: 'Active', icon: UserCheck, color: 'emerald' },
    { key: 'expiring_soon', label: 'Expiring Soon', icon: AlertCircle, color: 'orange' },
    { key: 'expired', label: 'Expired', icon: Calendar, color: 'red' },
    { key: 'rejected', label: 'Rejected', icon: UserX, color: 'gray' },
];

return (
    <div className=\"space-y-6 pb-20 fade-in\">
{/* Header */ }
<div className=\"flex items-center justify-between\">
    < div >
    <h1 className=\"text-3xl font-bold text-gray-900\">Member Management</h1>
        < p className =\"text-gray-600 mt-1\">Manage memberships and plans</p>
                </div >
    <div className=\"px-4 py-2 bg-emerald-100 text-emerald-700 rounded-xl font-bold\">
{ members.length } Total
                </div >
            </div >

    {/* Search Bar */ }
    < div className =\"relative\">
        < Search className =\"absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400\" />
            < input
type =\"text\"
placeholder =\"Search members by name or email...\"
value = { searchQuery }
onChange = {(e) => setSearchQuery(e.target.value)}
className =\"w-full pl-12 pr-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-emerald-500 transition-colors\"
    />
            </div >

    {/* Tabs */ }
    < div className =\"flex space-x-2 overflow-x-auto pb-2\">
{
    tabConfig.map((tab) => {
        const count = members.filter(m => getComputedStatus(m) === tab.key.toUpperCase()).length;
        const Icon = tab.icon;
        const isActive = activeTab === tab.key;

        return (
            <button
                key={tab.key}
                onClick={() => setActiveTab(tab.key as any)}
                className={`flex items-center gap-2 px-5 py-3 rounded-xl font-semibold whitespace-nowrap transition-all ${isActive
                    ? `bg-${tab.color}-100 text-${tab.color}-700 shadow-sm`
                    : \"bg-gray-100 text-gray-600 hover:bg-gray-200\"
    }`}
                        >
                            <Icon className=\"w-4 h-4\" />
                            {tab.label}
                            <span className={`px - 2 py - 0.5 rounded - full text - xs font - bold ${
        isActive? `bg-${tab.color}-200` : 'bg-gray-200'
                            } `}>
                                {count}
                            </span>
                        </button>
                    );
                })}
            </div>

            {/* Members Grid */}
            <div className=\"bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden\">
                {loading ? (
                    <div className=\"p-12 text-center\">
                        <div className=\"w-16 h-16 border-4 border-emerald-500 border-t-transparent rounded-full animate-spin mx-auto mb-4\"></div>
                        <p className=\"text-gray-500 font-medium\">Loading members...</p>
                    </div>
                ) : filteredMembers.length === 0 ? (
                    <div className=\"p-12 text-center\">
                        <div className=\"w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4\">
                            <User className=\"w-8 h-8 text-gray-400\" />
                        </div>
                        <p className=\"text-gray-900 font-medium mb-1\">No {activeTab.replace('_', ' ')} members</p>
                        <p className=\"text-sm text-gray-500\">
                            {searchQuery ? 'Try adjusting your search' : 'Members will appear here'}
                        </p>
                    </div>
                ) : (
                    <div className=\"divide-y divide-gray-100\">
                        {filteredMembers.map((member) => {
                            const status = getComputedStatus(member);
                            const expiryDate = member.plan?.expiry ? new Date(member.plan.expiry.seconds * 1000) : null;
                            const daysLeft = expiryDate ? Math.ceil((expiryDate.getTime() - new Date().getTime()) / (1000 * 60 * 60 * 24)) : null;

                            return (
                                <div key={member.id} className=\"p-6 hover:bg-gray-50 transition-colors\">
                                    <div className=\"flex items-start justify-between\">
                                        <div className=\"flex items-start gap-4 flex-1\">
                                            <div className=\"w-12 h-12 rounded-xl bg-gradient-to-br from-emerald-500 to-emerald-600 flex items-center justify-center text-white text-lg font-bold flex-shrink-0\">
                                                {member.name.charAt(0).toUpperCase()}
                                            </div>
                                            <div className=\"flex-1 min-w-0\">
                                                <div className=\"flex items-center gap-2 mb-1\">
                                                    <h3 className=\"font-bold text-gray-900\">{member.name}</h3>
                                                    <span className={`text - xs font - bold px - 2.5 py - 1 rounded - full ${
    status === 'ACTIVE' ? 'bg-emerald-100 text-emerald-700' :
        status === 'PENDING' ? 'bg-amber-100 text-amber-700' :
            status === 'EXPIRING_SOON' ? 'bg-orange-100 text-orange-700' :
                status === 'EXPIRED' ? 'bg-red-100 text-red-700' :
                    'bg-gray-100 text-gray-700'
} `}>
                                                        {status.replace('_', ' ')}
                                                    </span>
                                                </div>
                                                <p className=\"text-sm text-gray-600 mb-2\">{member.email}</p>
                                                
                                                <div className=\"flex flex-wrap gap-3 text-sm\">
                                                    {member.plan ? (
                                                        <>
                                                            <div className=\"flex items-center gap-1.5 text-gray-700\">
                                                                <CreditCard className=\"w-4 h-4 text-gray-400\" />
                                                                <span className=\"font-medium\">{member.plan.name}</span>
                                                            </div>
                                                            {expiryDate && (
                                                                <div className=\"flex items-center gap-1.5 text-gray-700\">
                                                                    <Calendar className=\"w-4 h-4 text-gray-400\" />
                                                                    <span>
                                                                        Expires {expiryDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
                                                                        {daysLeft !== null && daysLeft > 0 && (
                                                                            <span className=\"text-gray-500\"> ({daysLeft}d left)</span>
                                                                        )}
                                                                    </span>
                                                                </div>
                                                            )}
                                                        </>
                                                    ) : (
                                                        <span className=\"text-gray-500 italic\">No plan assigned</span>
                                                    )}
                                                </div>
                                            </div>
                                        </div>

                                        <div className=\"flex items-center gap-2 ml-4\">
                                            {status === 'PENDING' && (
                                                <>
                                                    <button
                                                        onClick={() => handleApprove(member.id)}
                                                        className=\"px-4 py-2 bg-emerald-600 text-white rounded-lg font-semibold hover:bg-emerald-700 transition-colors\"
                                                    >
                                                        Approve
                                                    </button>
                                                    <button
                                                        onClick={() => handleReject(member.id)}
                                                        className=\"px-4 py-2 bg-red-100 text-red-700 rounded-lg font-semibold hover:bg-red-200 transition-colors\"
                                                    >
                                                        Reject
                                                    </button>
                                                </>
                                            )}
                                            <button
                                                onClick={() => setSelectedMember(member)}
                                                className=\"px-4 py-2 bg-gray-100 text-gray-700 rounded-lg font-semibold hover:bg-gray-200 transition-colors flex items-center gap-1\"
                                            >
                                                {member.plan ? 'Change Plan' : 'Assign Plan'}
                                                <ChevronRight className=\"w-4 h-4\" />
                                            </button>
                                            <button
                                                onClick={() => handleRemoveMember(member.id, member.name)}
                                                className=\"p-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors\"
                                                title=\"Remove member\"
                                            >
                                                <Trash2 className=\"w-5 h-5\" />
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                )}
            </div>

            {/* Assign Plan Modal */}
            {selectedMember && (
                <div className=\"fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4\">
                    <div className=\"bg-white rounded-3xl shadow-2xl max-w-md w-full max-h-[90vh] overflow-y-auto\">
                        <div className=\"sticky top-0 bg-white border-b border-gray-100 px-6 py-5 flex items-center justify-between rounded-t-3xl\">
                            <div>
                                <h2 className=\"text-xl font-bold text-gray-900\">Assign Plan</h2>
                                <p className=\"text-sm text-gray-600 mt-0.5\">{selectedMember.name}</p>
                            </div>
                            <button
                                onClick={() => { setSelectedMember(null); setSelectedPlanId(\"\"); }}
                                className=\"p-2 hover:bg-gray-100 rounded-xl transition-colors\"
                            >
                                <X className=\"w-5 h-5 text-gray-500\" />
                            </button>
                        </div>

                        <div className=\"p-6 space-y-4\">
                            {plans.length === 0 ? (
                                <p className=\"text-center text-gray-500 py-8\">No plans available. Create a plan first.</p>
                            ) : (
                                <>
                                    <div className=\"space-y-2\">
                                        {plans.map((plan) => (
                                            <label
                                                key={plan.id}
                                                className={`block p - 4 border - 2 rounded - xl cursor - pointer transition - all ${
    selectedPlanId === plan.id
        ? 'border-emerald-500 bg-emerald-50'
        : 'border-gray-200 hover:border-gray-300'
} `}
                                            >
                                                <input
                                                    type=\"radio\"
                                                    name=\"plan\"
                                                    value={plan.id}
                                                    checked={selectedPlanId === plan.id}
                                                    onChange={() => handlePlanChange(plan.id)}
                                                    className=\"sr-only\"
                                                />
                                                <div className=\"flex items-center justify-between\">
                                                    <div>
                                                        <p className=\"font-bold text-gray-900\">{plan.name}</p>
                                                        <p className=\"text-sm text-gray-600 mt-0.5\">{plan.durationMonths} months</p>
                                                    </div>
                                                    <p className=\"text-xl font-bold text-emerald-600\">â‚¹{plan.price}</p>
                                                </div>
                                            </label>
                                        ))}
                                    </div>

                                    <button
                                        onClick={handleAssignPlan}
                                        disabled={!selectedPlanId}
                                        className=\"w-full py-3 bg-emerald-600 text-white rounded-xl font-bold hover:bg-emerald-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all\"
                                    >
                                        Assign Plan
                                    </button>
                                </>
                            )}
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
}
